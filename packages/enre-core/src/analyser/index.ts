import {parse} from '@babel/parser';
import traverse from '@babel/traverse';
import {eGraph, recordEntityFile, rGraph} from '@enre/container';
import environment from '@enre/environment';
import {verbose} from '@enre/logging';
import path from 'path';
import {getFileContent} from '../utils/fileFinder';
import {ENREContext} from './context';
import traverseOpts from './visitors';

/**
 * Read, parse and analyse a single file by a giving file path.
 */
export const analyse = async (filePath: string) => {
  const currFile = recordEntityFile(
    path.basename(filePath),
    [path.dirname(filePath)],
    // TODO: sourceType detect
    'module',
    // TODO: Migrate lang to ts enum
    path.extname(filePath).includes('ts') ? 'ts' : 'js');

  verbose(`Record Entity File: ${currFile.fullName}`);

  const content = await getFileContent(filePath);

  const ast = parse(content, {
    // This seems to be a parser bug, which only affects the first line
    // startColumn: 1,
    sourceType: currFile.sourceType,
    plugins: ['typescript'],
    /**
     * Enabling error recovery suppresses some TS errors
     * and make it possible to deal with in user space.
     */
    errorRecovery: true,
  });

  /**
   * A stack to help trace AST traverse process for parent determination.
   *
   * The first element is always the file to be processed.
   */
  const context = new ENREContext(currFile);

  /**
   * Using cjs default export in esm causes a complicated issue,
   * since during the development pipeline, this code will be executed
   * in two different environments, the first one is nodejs where js files
   * are generated by tsc, which does not rewrite module-interop staffs,
   * in which case, a `.default` is necessary; however, in the second environment,
   * that is the jest testing environment, js files are generated by babel,
   * who will smartly append a `.default`, which makes code in here an error.
   * To support both cases, here according to the NODE_ENV, the `.default` is
   * appended or not.
   */
  if (environment.test) {
    traverse(ast, traverseOpts(context));
  } else {
    // @ts-ignore
    traverse.default(ast, traverseOpts(context));
  }

};

export const cleanAnalyse = () => {
  eGraph.reset();
  rGraph.reset();
};
